<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<title>LaserWeb - A fully featured Web UI for Lasercutters running Marlin or Smoothieware</title>

 <!-- Socket and UI -->
	<script src="/socket.io/socket.io.js"></script>
	<script src="/jquery.min.js"></script>
	<script src="/jquery-ui.js"></script>
	<script src="/bootstrap.min.js"></script>
	<script src="/bootstrap-notify.js"></script>
	<!--script src="/main.js"></script -->

 <!-- v70 Three.js -->
	<script src="/openjscad/lib/three.min.js"></script>
	<script src="/openjscad/GridRect.js"></script>  <!-- Courtesy of https://github.com/mrdoob/three.js/issues/6549 -->
	<script src="/openjscad/lib/orbitcontrols.js"></script>
	<script src="/gcode-viewer/gcode-parser.js"></script>
	<script src="/gcode-viewer/renderer.js"></script>
	<script src="/gcode-viewer/ui.js"></script>

 <!-- Millcrum -->
	<script type="text/javascript" src="/millcrum/inc/mc.js"></script>
	<script type="text/javascript" src="/millcrum/inc/dxf.js"></script>
	<script type="text/javascript" src="/millcrum/inc/svg.js"></script>

	<link rel="stylesheet" href="/jquery-ui.css" />
	<link rel="stylesheet" href="/bootstrap.min.css" />
	<link rel="stylesheet" href="/bootstrap-theme.min.css" />
	<link rel="stylesheet" href="/bootstrap-notify.css" />
	<link rel="stylesheet" href="/font-awesome.css">
	<link rel="stylesheet" href="/screen.css" />

	<!-- Gear Generator : http://hessmer.org/gears/InvoluteSpurGearBuilder.html-->

  <script src="/openjscad/lib/projector.js"></script><!-- fallback if no WebGL -->
  <script src="/openjscad/lib/canvasrenderer.js"></script><!-- fallback if no WebGL -->
  <script src="/openjscad/src/csg.js"></script>
  <script src="/openjscad/src/threecsg.js"></script>
  <script src="/openjscad/src/openjscad.js"></script>
	<script src="/openjscad/src/openscad.js"></script>
  <script src="/openjscad/src/formats.js"></script>
  <script src="/openjscad/TrackballControls.js"></script>
	<link rel="stylesheet" href="/openjscad/openjscad.css" type="text/css">
	<script src="/openjscad/LaserWebapps.js"></script> <!-- Add additional OpenJSCAD apps init scripts in here -->

  <style>
  #canvas-1 {
    border: 1px solid black;
		width: 600px;
		height: 400px;
    }


  </style>

  <script type="text/javascript" src="paper-full.js"></script>



</head>
<body>

<script type="text/javascript">

laserxmax = 600;  // Defined in main.js - don't port to Laserweb
laserymax = 400;  // Defined in main.js - don't port to Laserweb
firmware = 'Grbl 0.9j'// Defined in main.js - don't port to Laserweb

var paperscript = {};

$(document).ready(function() {

	// OpenJsCad
	$('#rasterT').on('click', function() {
		$('#rasT').addClass('active');
		$('#papT').removeClass('active');
		$('#rasgcT').removeClass('active');
		$('#rasterView').show();
		$('#paperView').hide();
		$('#rastergcView').hide();
	});
	$('#paperT').on('click', function() {
		$('#rasT').removeClass('active');
		$('#papT').addClass('active');
		$('#rasgcT').removeClass('active');
		$('#rasterView').hide();
		$('#paperView').show();
		$('#rastergcView').hide();
	});
	$('#rastergcDA').on('click', function() {
		$('#rasT').removeClass('active');
		$('#papT').removeClass('active');
		$('#rasgcT').addClass('active');
		$('#rasterView').hide();
		$('#paperView').hide();
		$('#rastergcView').show();
	});


	var paperscript = {};

	var fileImg = document.getElementById('fileImage');

	fileImg.addEventListener('change', function(e) {
	  var selectedFile = event.target.files[0];
	  var reader = new FileReader();

	  var imgtag = document.getElementById("origImage");
	  imgtag.title = selectedFile.name;

	  reader.onload = function(event) {
	    imgtag.src = event.target.result;
	    var img = document.getElementById('origImage');
	    width = img.clientWidth;
	    height = img.clientHeight;
	    $("#dims").text(width+'px x '+height+'px');
	    //$('#canvas-1').prop('width', (width*3));
	    //$('#canvas-1').prop('height', (height*3));
			$('#canvas-1').prop('width', laserxmax);
	    $('#canvas-1').prop('height', laserymax);
	    var physwidth = $('#spotSize').val() * width;
	    var physheight = $('#spotSize').val() * height;
	    $("#physdims").text(physwidth.toFixed(1)+'mm x '+physheight.toFixed(1)+'mm');
			$('#laserpwrslider').removeClass('disabled');
	  };

	  reader.readAsDataURL(selectedFile);
	});

	$( "#laserpwrslider" ).slider({
      range:true,
      min: 0,
      max: 100,
      values: [ 30, 70 ],
      slide: function( event, ui ) {
        $( "#laserpwr" ).val( "Power: " + ui.values[ 0 ] + "% - " + ui.values[ 1 ] + '%' );
				minpwr = [ui.values[ 0 ]];
				maxpwr = [ui.values[ 1 ]];
				$('#rasterNow').removeClass('disabled');
			}
  });


	$( "#laserpwr" ).val( "Power: " + $( "#laserpwrslider" ).slider( "values", 0 ) +
	       "% - " + $( "#laserpwrslider" ).slider( "values", 1 ) +'%'
	);

	$('#rasterNow').on('click', function() {
		spotSize = $('#spotSize').val();
		laserFeed = $('#feedRate').val();
		window.globals = {
				minpwr2: [minpwr],
				maxpwr2: [maxpwr],
				spotSize: [spotSize],
				imgH: [height],
				imgW: [width],
				feed: [laserFeed]
		};
		window.paper.RasterNow();
	});


  $('#spotSize').bind('input propertychange', function() {
        //console.log('empty');
        // Todo if empty
        if(this.value.length){
          var physwidth = $('#spotSize').val() * width;
          var physheight = $('#spotSize').val() * height;
          $("#physdims").text(physwidth.toFixed(1)+'mm x '+physheight.toFixed(1)+'mm <br>');
        }
  });

	$('#SendLW').on('click', function() {
		PostGcode();
	});

});


function PostGcode() {
    //var alert = showAlert("Sending gcode LaserEeb", "alert-info", false);
    $.ajax({
        url: "/api/upload",
        type: "POST",
        data: { val: $('#code').val() },
        dataType: "json",
    })
    .done(function (content) {
        //alert.remove();
    })
    .fail(function (e) {
        //alert.remove();
        //showAlert("Can't save gcode to LaserWeb", "alert-danger");
    });
}
</script>


<script type="text/paperscript" canvas="canvas-1">

			this.RasterNow = function(){
				// Initialise
				project.clear();
				$('#load').show();
				var path = '';
				var raster = '';
        var lastgrey = '';
				var intensity = '';
				var gcodex = '';
				var gcodey = '';


				//Pull params from the Global context
				var minIntensity = globals.minpwr2;
				var maxIntensity = globals.maxpwr2;
				var spotSize1 = globals.spotSize;
				var imgheight = globals.imgH;
				var imgwidth = globals.imgW;
				var feedRate = globals.feed;

				// Log it as a sanity check
				console.log('Constraining Laser power between '+minIntensity+'% and '+maxIntensity+'%');
				console.log('Height: '+imgheight+'px, Width: '+imgwidth+'px');
				console.log('Spot Size: '+spotSize1+'mm');

          // Create a raster item using the image tag 'origImage'
        var raster = new Raster('origImage');

				// Hide the raster:
        //raster.visible = true;
        raster.visible = false;

        // The size of our grid cells:
        var gridSize = 1;

        // Space the cells by 120%:
        var spacing = 1.3;

        // As the web is asynchronous, we need to wait for the raster to load
        // before we can perform any operation on its pixels.
        raster.on('load', function() {

          var imgheight = globals.imgH;
          var imgwidth = globals.imgW;

          console.log('Width: '+imgwidth+'  Height: '+imgheight);

					// Init some variables we'll be using in the process
          s = ''; // Resultant gcode
          c = 0; // Keep count of Gcode lines so we can optimise, lower = better
          xm = 0; // Keep count of Gcode lines so we can optimise, lower = better
          //skip = 0;
					var lastPosx = '0';
					var lastPosy = '0';
					var lastIntensity = '0';


					s += '; GCODE generated by Laserweb \n';
					s += '; Laser Max: '+minIntensity+'%\n';
					s += '; Laser Min: '+maxIntensity+'%\n';
					s += '; Laser Spot Size '+spotSize1+'mm\n';
					s += '; Laser Feedrate '+feedRate+'mm/min\n\n';
					s += 'G28\nG21\nG90\nG1 F'+feedRate+'\n';
					//s += 'G0 Y'+imgheight+' F'+feedRate+'\nG92 X0 Y0;'; // Raster runs top to bottom o we offset by the height


					for (var y = 0; y < raster.height; y++) {
						var newline = (imgheight * spotSize1) - y
						//s += 'G0 X0 Y'+newline+' F'+feedRate+'\n'
						for(var x = 0; x < raster.width; x++) {
							// Get the color of the pixel:
        			var color = raster.getPixel(x, y);
							// Scale the path by the amount of gray in the pixel color:
              var grayLevel = color.gray.toFixed(1);  // var grayLevel = color.gray.toFixed(2); // two decimal precision is plenty - for testing I will drop it to 1 decimal (10% increments)
							posx = x;
							posy = y;

							// Optimise: when the greyValue is the same as the one before, we don't write it, we append it and write on longer G1 move instead
							if (typeof lastGrey != 'undefined' && lastGrey == grayLevel) {  // Optimisation code:  Test file without this was 50363 lines, with this was only 18292 lines.
								//console.log('Could Optimise, still on '+grayLevel);
								xm++; // Increment the X step over
							} else {
									if (xm > 0) {
										posx = posx + (xm / 1000);
									}

									intensity = (1 -grayLevel) * 100; //  Also add out Firmware specific mapping using intensity (which is 0-100) and map it between minIntensity and maxIntensity variables above * firmware specific multiplier (grbl 0-255, smoothie 0-1, etc)
									intensity = intensity.toFixed(0);

									c++;
									xm = 0;
									//console.log('From: '+lastPosx+', '+lastPosy+'  - To: '+posx+', '+posy+' at '+lastIntensity+'%');

									gcodey = (imgheight * spotSize1) - posy  // Offset Y since Gcode runs from bottom left and paper.js runs from top left
									gcodey = gcodey.toFixed(1);


									posx = (posx * spotSize1);
									posy = (posy * spotSize1);
									posx = posx.toFixed(1);
									posy = posy.toFixed(1);

									gcodey = (imgheight * spotSize1) - posy  // Offset Y since Gcode runs from bottom left and paper.js runs from top left
									gcodey = gcodey.toFixed(1);

									//console.log('Height: '+imgheight+'px, Width: '+imgwidth+'px');
									if (firmware.indexOf('Grbl') == 0) {
											s += 'M3\n'
									}
									if (lastIntensity == 0) {
										// If we are not burning, there is no need to move the laser
										s += 'G1 S'+lastIntensity+'\n'
									} else {
										s += 'G1 X'+posx+' Y'+gcodey+' S'+lastIntensity+'\n';
									}
									
									if (firmware.indexOf('Grbl') == 0) {
											s += 'M5\n'
									}

									path = new Path.Line({
									    from: [(lastPosx * gridSize), (lastPosy * gridSize)],
									    to: [(posx * gridSize), (posy * gridSize)],
									    strokeColor: 'black'
									});
									path.strokeColor = 'black';
									//path.scale(1 - grayLevel);
									path.opacity = (lastIntensity / 100);
									// store to use in next loop
									var lastPosx = posx;
									var lastPosy = posy;
									var lastIntensity = intensity;
									}
              var lastGrey = grayLevel; // store to compare in next loop
        		}
					}

					// Not using this for LaserWeb at the moment but leaving here if we need to later
        	// Move the active layer to the center of the view, so all
        	// the created paths in it appear centered.
        	//project.activeLayer.position = view.center;

					// Populate the GCode textarea
          document.getElementById('code').value = s;
          //console.log('Optimsed by number of line: '+skip);
          console.log('Number of GCode Moves: '+c);
        });
  }
</script>


<!-- Tabs -->
<ul class="nav nav-tabs nav-justified" role="tablist">
	<li id="rasT"  class="active">
		<a id="rasterT" href="#">Engraving Setup</a>
	</li>
	<li id="papT">
		<a id="paperT" href="#">Raster Preview</a>
	</li>
	<li id="rasgcT">
		<a id="rastergcDA" href="#">GCODE</a>
	</li>
</ul>
<!-- Tab 1 -->
<div id="rasterView">
	<div class="btn-group input-group  btn-group-justified">
		<div class="btn-group" role="group"><button type="button" class="btn btn-info btn-file btn-sm"><i class="fa fa-folder-open fa-lg"></i>&nbsp;Image<input type="file" accept=".png,.jpg,.jpeg"  id="fileImage" /></button></div>
	</div>
	<p>

	<div class="input-group" style="margin-bottom:10px; width: 100%;">
		<span class="input-group-addon"  style="width: 100px;"><i class="fa fa-dot-circle-o fa-lg" style="margin-right: 20px;"></i>Laser Spot Size:</span>
		<input type="text" class="form-control" value="0.1" id="spotSize">
		<span class="input-group-addon"  style="width: 60px;">mm</span>
	</div>

	<div class="well">
		<label for="price">Constrain Laser:</label>
			 <input type="text" id="laserpwr"
					style="border:0; color:#aa0000; font-weight:bold;">
		</p>
		<div id="laserpwrslider"></div>
	</div>

	<div class="input-group" style="margin-bottom:10px; width: 100%;">
		<span class="input-group-addon"  style="width: 100px;"><i class="fa fa-line-chart fa-lg" style="margin-right: 20px;"></i>Engrave Feedrate</span>
		<input type="text" class="form-control" value="2000" id="feedRate">
		<span class="input-group-addon"  style="width: 60px;">mm/min</span>
	</div>
	<br>
	<div class="btn-group" role="group"><a class="btn btn-danger disabled" id="rasterNow"><i class="fa fa-square-o fa-lg" style="margin-right: 3px;"></i>Prepare Raster</a></div></div>


	Imported Image Dimensions: <span id="dims">0px x 0 px</span></span>
	Engraved Image Dimensions: <span id="physdims">0mm x 0 mm</span></span>
	<img id="origImage">

</div>

<!-- Tab 2 -->
<div id="paperView" style="display: none;">
	<div class="canvas" id="rasterOutput">
		<canvas id="canvas-1"></canvas>
	</div>
</div>

<!-- Tab 3 -->
<div id="rastergcView" style="display: none;">

	 <textarea id="code" name="b" style="width: 600px; height: 200px;"></textarea>
   <input type="botton" name="button" id="SendLW" value="Send to LaserWeb" />
   </form>

</div>
</ul>


</body>
</html>
